name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: eu-west-2
  AWS_ACCOUNT_ID: 773913840750
  ECR_REPO_NAME: memos
  ECS_CLUSTER: memos-dev-cluster
  ECS_SERVICE: memos-dev-service
  APP_URL: tm.tomakady.com
  TERRAFORM_VERSION: 1.8.5
  PROJECT_NAME: memos
  ENVIRONMENT: dev

jobs:
  validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: |
          cd infra
          terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Validate
        run: |
          cd infra
          terraform init -backend=false
          terraform validate

  setup-backend:
    name: Setup Terraform Backend
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create S3 bucket for Terraform state
        run: |
          if ! aws s3 ls s3://${{ env.PROJECT_NAME }}-terraform-state 2>/dev/null; then
            aws s3api create-bucket \
              --bucket ${{ env.PROJECT_NAME }}-terraform-state \
              --region ${{ env.AWS_REGION }} \
              --create-bucket-configuration LocationConstraint=${{ env.AWS_REGION }}

            aws s3api put-bucket-versioning \
              --bucket ${{ env.PROJECT_NAME }}-terraform-state \
              --versioning-configuration Status=Enabled

            aws s3api put-bucket-encryption \
              --bucket ${{ env.PROJECT_NAME }}-terraform-state \
              --server-side-encryption-configuration '{
                "Rules": [{
                  "ApplyServerSideEncryptionByDefault": {
                    "SSEAlgorithm": "AES256"
                  }
                }]
              }'

            aws s3api put-public-access-block \
              --bucket ${{ env.PROJECT_NAME }}-terraform-state \
              --public-access-block-configuration \
                BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true

            echo "S3 bucket created and configured"
          else
            echo "S3 bucket already exists"
          fi

      - name: Create DynamoDB table for state locking
        run: |
          if ! aws dynamodb describe-table --table-name ${{ env.PROJECT_NAME }}-terraform-locks --region ${{ env.AWS_REGION }} 2>/dev/null; then
            aws dynamodb create-table \
              --table-name ${{ env.PROJECT_NAME }}-terraform-locks \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --region ${{ env.AWS_REGION }}
            echo "DynamoDB table created"
          else
            echo "DynamoDB table already exists"
          fi

  terraform-ecr:
    name: Terraform Create ECR
    runs-on: ubuntu-latest
    needs: setup-backend
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init and Apply (ECR only)
        run: |
          cd infra
          terraform init

          # Check if ECR exists and import if needed
          if aws ecr describe-repositories --repository-names ${{ env.ECR_REPO_NAME }} --region ${{ env.AWS_REGION }} 2>/dev/null; then
            if ! terraform state show module.ecr.aws_ecr_repository.this 2>/dev/null; then
              echo "ECR exists in AWS but not in Terraform state. Importing..."
              terraform import module.ecr.aws_ecr_repository.this ${{ env.ECR_REPO_NAME }}
            fi
          fi

          terraform plan -target=module.ecr -out=tfplan-ecr
          terraform apply -auto-approve tfplan-ecr

  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: terraform-ecr
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/${{ env.ECR_REPO_NAME }}:$IMAGE_TAG ./app
          docker tag $ECR_REGISTRY/${{ env.ECR_REPO_NAME }}:$IMAGE_TAG $ECR_REGISTRY/${{ env.ECR_REPO_NAME }}:latest
          docker push $ECR_REGISTRY/${{ env.ECR_REPO_NAME }}:$IMAGE_TAG
          docker push $ECR_REGISTRY/${{ env.ECR_REPO_NAME }}:latest

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO_NAME }}:${{ github.sha }}
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          ignore-unfixed: true
        continue-on-error: true

  terraform-infra:
    name: Terraform Apply Infrastructure
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Apply
        run: |
          cd infra
          terraform init
          terraform plan -out=tfplan
          terraform apply -auto-approve tfplan

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: terraform-infra
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Wait for ECS service to stabilize
        run: |
          echo "Waiting for ECS service to become stable..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }}

      - name: Deployment Summary
        run: |
          echo "## âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application URL:** https://${{ env.APP_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**ECS Cluster:** \`${{ env.ECS_CLUSTER }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**ECS Service:** \`${{ env.ECS_SERVICE }}\`" >> $GITHUB_STEP_SUMMARY
