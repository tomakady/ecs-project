name: Deploy Infrastructure

on:
  workflow_dispatch:

env:
  AWS_REGION: eu-west-2
  AWS_ACCOUNT_ID: 773913840750
  ECR_REPO_NAME: memos-dev
  ECS_CLUSTER: memos-dev-cluster
  ECS_SERVICE: memos-dev-service
  APP_URL: tm.tomakady.com
  TERRAFORM_VERSION: 1.8.5
  TFLINT_VERSION: v0.50.0

jobs:
  bootstrap-iam:
    name: Bootstrap IAM
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check if IAM role exists
        id: check-role
        run: |
          if aws iam get-role --role-name memos-dev-github-actions-role 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Set up Terraform
        if: steps.check-role.outputs.exists == 'false'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Create IAM resources
        if: steps.check-role.outputs.exists == 'false'
        working-directory: ./infra
        run: |
          terraform init
          terraform apply -target=module.iam -auto-approve

  validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    needs: bootstrap-iam
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        working-directory: ./infra
        run: terraform fmt -check -recursive

      - name: Terraform Init
        working-directory: ./infra
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: ./infra
        run: terraform validate

      - name: Set up TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Run TFLint
        working-directory: ./infra
        run: |
          tflint --init
          tflint

      - name: Validation Summary
        run: |
          echo "## Terraform Validation" >> $GITHUB_STEP_SUMMARY
          echo "- Format check passed" >> $GITHUB_STEP_SUMMARY
          echo "- Configuration validated" >> $GITHUB_STEP_SUMMARY
          echo "- TFLint checks passed" >> $GITHUB_STEP_SUMMARY

  build-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/memos-dev-github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPO_NAME:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPO_NAME:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPO_NAME:latest

      - name: Push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPO_NAME:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPO_NAME:latest

      - name: Build Summary
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "## Docker Build" >> $GITHUB_STEP_SUMMARY
          echo "- Image: $ECR_REGISTRY/$ECR_REPO_NAME:$IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "- Latest: $ECR_REGISTRY/$ECR_REPO_NAME:latest" >> $GITHUB_STEP_SUMMARY

  terraform-deploy:
    name: Terraform Deploy
    runs-on: ubuntu-latest
    needs: build-push
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/memos-dev-github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: ./infra
        run: terraform init

      - name: Terraform Plan
        working-directory: ./infra
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        working-directory: ./infra
        run: terraform apply -auto-approve tfplan

      - name: Deployment Summary
        run: |
          echo "## Terraform Deployment" >> $GITHUB_STEP_SUMMARY
          echo "Infrastructure deployed successfully" >> $GITHUB_STEP_SUMMARY

  health-check:
    name: Post-Deploy Health Check
    runs-on: ubuntu-latest
    needs: terraform-deploy
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/memos-dev-github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Wait for ECS service to stabilize
        run: |
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }}

      - name: Health Check
        run: |
          sleep 30
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.APP_URL }}/health)
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "Health check passed (HTTP $HTTP_CODE)"
          else
            echo "Health check failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Final Summary
        if: success()
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application URL:** https://${{ env.APP_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY